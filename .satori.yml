settings:
  name: Satori CLI Test
  log: slack

import:
  - "satori://code/trufflehog.yml"
  - "satori://code/semgrep-secrets.yml"
  #- "satori://code/semgrep.yml"
  #- "satori://code/python/pylint.yml"

tests:
  assertReturnCode: 0
  install_satori:
    test:
    - [ pip install . ]

  create_profile:
    assertStdoutContains: "Token saved"
    test:
    - [ satori-cli config token "not_a_token" -p test_user ]

  set_token:
    assertStdoutContains: "Token saved"
    test:
    - [ satori-cli config token "$(TOKEN)" ]

  dashboard:
    test:
    - [ satori-cli ]

  pass_report:
    test:
    - [ satori-cli run .satori/import/pass.yml --report ]

  import_sync:
    test:
    - [ satori-cli run .satori/import --sync ]

  run_url_output:
    test:
    - [ "satori-cli run satori://web/testssl.yml --data=\"{'URL':'https://www.satori-ci.com'}\" --output" ]

report:
  assertReturnCode: 0
  list:
    test:
    - [ satori-cli report ]

  new_sync:
    - ["satori-cli run .satori/import/pass.yml -s | grep 'Report ID' | egrep 'r[a-zA-Z0-9]{15}' -o >> report_id.txt"]

  echo:
    - [ export ID=$(cat report_id.txt); echo $ID ]

  single:
    test:
    - [ export ID=$(cat report_id.txt); satori-cli report $ID ]

  output:
    test:
    - [ export ID=$(cat report_id.txt); satori-cli report $ID output ]

  delete:
    test:
    - [ export ID=$(cat report_id.txt); satori-cli report $ID delete ]

  new_async: # new report for stop is needed because the first one is already stopped
    - ["satori-cli run .satori/import/pass.yml | grep 'Report ID' | egrep 'r[a-zA-Z0-9]{15}' -o >> report_id2.txt"]

  sleep: # wait until start
    - [ sleep 10 ]

  stop:
    test:
    - [ export ID=$(cat report_id2.txt); satori-cli report $ID stop ]

  delete_async:
    test:
    - [ export ID=$(cat report_id2.txt); satori-cli report $ID delete ]


playbook:
  assertReturnCode: 0
  list:
    test:
    - [ satori-cli playbook ]

  list_public:
    test:
    - [ satori-cli playbook --public ]

  single:
    test:
    - [ export ID=$(cat report_id2.txt); satori-cli playbook $ID ]

  playbook:
    test:
    - [ export ID=$(cat report_id2.txt); satori-cli playbook $ID delete ]

repo:
  assertReturnCode: 0
  list:
    test:
    - [ satori-cli repo ]

  single:
    test:
    - [ satori-cli repo satorici/satori-cli ]

  commits:
    test:
    - [ satori-cli repo satorici/satori-cli commits ]

  # check_commits:
  #   test:
  #   - [ satori-cli repo satorici/satori-cli check_commits ]

  # check_forks:
  #   test:
  #   - [ satori-cli repo satorici/satori-cli check_forks ]

  # scan:
  #   test:
  #   - [ satori-cli repo satorici/satori-cli scan ]

  # scan_stop:
  #   test:
  #   - [ satori-cli repo satorici/satori-cli scan-stop ]

  # run:
  #   test:
  #   - [ satori-cli repo satorici/satori-cli run ]

  # clean:
  #   test:
  #   - [ satori-cli repo satorici/satori-cli clean ]

monitor:
  assertReturnCode: 0
  list:
    test:
    - [ satori-cli monitor ]

  # single:
  #   test:
  #   - [ satori-cli monitor $(MONITOR_ID) ]

  # start:
  #   test:
  #   - [ satori-cli monitor $(MONITOR_ID) start ]

  # stop:
  #   test:
  #   - [ satori-cli monitor $(MONITOR_ID) stop ]

  # delete:
  #   test:
  #   - [ satori-cli monitor $(MONITOR_ID) delete ]

teams:
  assertReturnCode: 0
  list:
    test:
    - [ satori-cli team ]

  # create:
  #   test:
  #   - [ satori-cli team $(TEAM_ID) create ]

  # single:
  #   test:
  #   - [ satori-cli team $(TEAM_ID) ]

  # members:
  #   test:
  #   - [ satori-cli team $(TEAM_ID) members ]

  # add_member:
  #   test:
  #   - [ satori-cli team $(TEAM_ID) add_member --email="user@email.com" ]

  # repos:
  #   test:
  #   - [ satori-cli team $(TEAM_ID) repos ]

  # add_repo:
  #   test:
  #   - [ satori-cli team $(TEAM_ID) add_repo --repo="non/repo" ]

  # delete:
  #   test:
  #   - [ satori-cli team $(TEAM_ID) delete" ]

# tests_fail:
#   assertReturnCode: 1
#   fail:
#     test:
#     - [ satori-cli run .satori/fail.yml --report ]

#   empty:
#     test:
#     - [ satori-cli run .satori/empty.yml --report ]